<dom-module id="q-feed">
    <template>
        <style>

            .hbox {
                @apply --layout-horizontal;
            }
            .flex {
                @apply --layout-flex;
            }
            paper-button {
                color: #fff;
                background-color: var(--paper-blue-500);
                font-size: 14px;
                font-weight: normal;
            }
            :host {
                position: fixed;
                bottom: 0;
                width: 100%;
                box-sizing: border-box;
                padding: 10px;
                display: none;
                background-color: var(--paper-grey-200);
                font-family: 'Segoe UI', Roboto, Arial, sans-serif;
                z-index: 2;
            }
            :host([opened]) {
                display: block;
            }
        </style>
        <q-ajax id="ajax"></q-ajax>
        <q-session session="{{ session }}"></q-session>

        <div class="hbox">
            <div class="flex" style="text-align: left;">
                <paper-button hidden$="[[ authorized ]]" on-tap="__onAuthorizeTap" id="button-request">Authorize</paper-button>
            </div>
            <div class="flex" style="text-align: right;">
                <paper-button hidden$="[[ granted ]]" on-tap="__onPermissionTap" id="button-request">Permission</paper-button>
            </div>
        </div>

    </template>
    <script>
        class QFeed extends Polymer.Element {
            static get is() {
                return 'q-feed';
            }

            static get properties() {
                return {
                    opened: { type: Boolean, value: false, reflectToAttribute: true },
                    granted: { type: Boolean, value: false, reflectToAttribute: true },
                    authorized: { type: Boolean, value: false, reflectToAttribute: true }
                }
            }

            ready() {
                super.ready();

                this._ensureAttribute('authorized', true);
                this._ensureAttribute('granted', true);

                if (window.firebase === undefined) {
                    let fb = document.createElement('script');
                    fb.src = 'https://www.gstatic.com/firebasejs/4.10.1/firebase.js';
                    fb.onload = this.__onFirebaseLoad.bind(this);
                    document.body.appendChild(fb);
                }
            }

            __onFirebaseLoad() {
                firebase.initializeApp({
                    apiKey: 'AIzaSyB9eqpS9EZYOk_9Yok8Rm-g3nBjqs0W7lw',
                    authDomain: 'qtool-196208.firebaseapp.com',
                    databaseURL: 'https://qtool-196208.firebaseio.com',
                    projectId: 'qtool-196208',
                    storageBucket: '',
                    messagingSenderId: '291581890497'
                }); 

                // authenticate
                if ( ! this.session.feed_authorization) {
                    this.set('authorized', false);
                    this.set('opened', true);
                } else {
                    this.__notify();
                }
                
                if (/^https/.test(location.protocol)) {
                    this.__setup();
                }

            }

            __setup() {

                let messaging = this.__messaging =  firebase.messaging();
                // this.__auth = firebase.auth();
                // this.__authProvider = new firebase.auth.GoogleAuthProvider();

                messaging.usePublicVapidKey('BKvx8BwtL-Y8T0SuMLszQUu6m5hj3rhf4y2A3yqB1SJxYlOdh0j__FFkHN3jtdwOobiiC2-SifcdKvYKMF1f1UA');

                messaging.onMessage(payload => {
                    console.log(payload);
                });

                messaging.onTokenRefresh(() => {
                    messaging.getToken()
                        .then(refreshedToken => {
                            this.__setTokenSentToServer(false);
                            this.__sendTokenToServer(refreshedToken);
                        })
                        .catch(err => {
                            console.log(err);
                            this.__setTokenSentToServer(false);
                        });
                });

                navigator.serviceWorker.register('/qtool/worker.js').then(reg => {
                    messaging.useServiceWorker(reg);

                    messaging.getToken()
                        .then(currentToken => {
                            if (currentToken) {
                                this.__sendTokenToServer(currentToken);
                                // updateUIForPushEnabled(currentToken);
                            } else {
                                this.set('granted', false);
                                this.set('opened', true);
                                // permission request.
                                // updateUIForPushPermissionRequired();
                                this.__setTokenSentToServer(false);
                            }
                        })
                        .catch(err => {
                            console.log(err);
                        });
                    });
            }

            __isTokenSentToServer() {
                return this.session.feed_token_sent == 1;
            }

            __setTokenSentToServer(sent) {
                this.set('session.feed_token_sent', sent ? 1 : 0);
            }

            __sendTokenToServer(token) {
                if ( ! this.__isTokenSentToServer()) {
                    this.$.ajax.post('/api/feed/save-token', {
                        token: token
                    });
                }
            }

            __notify() {
                // notify all
                this.$.ajax.post('https://www.pusdikadm.xyz/qtool/api/feed/notify/qtool', {
                    title: 'Hei Baby',
                    body: 'I want to make love',
                    authorization: this.session.feed_authorization
                });
            }

            __onPermissionTap() {
                let messaging = this.__messaging;

                messaging.requestPermission()
                    .then( _ => {
                        this.set('granted', true);
                        this.set('opened', false);
                    });
            }

            __onAuthorizeTap() {
                let provider = new firebase.auth.GoogleAuthProvider();
                provider.addScope('https://www.googleapis.com/auth/firebase https://www.googleapis.com/auth/firebase.database https://www.googleapis.com/auth/firebase.messaging https://www.googleapis.com/auth/identitytoolkit https://www.googleapis.com/auth/userinfo.email');

                firebase.auth().signInWithPopup(provider).then(res => {
                    this.set('session.feed_authorization', res.credential.accessToken);
                    this.__notify();
                    this.set('authorized', true);
                    this.set('opened', false);
                });
            }


        }
        customElements.define(QFeed.is, QFeed);
    </script>
</dom-module>